name: deploy to gitee

on:
  schedule:
    - cron: "0 0/1 * * *"
  
jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          
      - uses: oprypin/find-latest-tag@v1
        id: sib-latest-tag
        with:
          repository: SonicCloudOrg/sonic-ios-bridge
          
      - uses: oprypin/find-latest-tag@v1
        id: sgm-latest-tag
        with:
          repository: SonicCloudOrg/sonic-go-mitmproxy

      - name: JSON to variables
        uses: antifree/json-to-variables@v1.0.1
        with:
          filename: 'version.json'
          prefix: test

      - name: replace sib
        run: |
          sib_new_ver=${{ steps.sib-latest-tag.outputs.tag }}
          sib_new_ver_sub=${sib_new_ver:1}
          sib_old_ver=${{ env.test_sib }}
          sib_old_ver_sub=${sib_old_ver:4}
          sed -i "s/${sib_old_ver}/sib_${sib_new_ver_sub}/g" version.json
          sed -i "s/${sib_old_ver_sub}/${sib_new_ver_sub}/g" src/markdown/sib/re-sib.md
          
      - name: replace sgm
        run: |
          sgm_new_ver=${{ steps.sgm-latest-tag.outputs.tag }}
          sgm_new_ver_sub=${sgm_new_ver:1}
          sgm_old_ver=${{ env.test_sgm }}
          sgm_old_ver_sub=${sgm_old_ver:4}
          sed -i "s/${sgm_old_ver}/sgm_${sgm_new_ver_sub}/g" version.json
          sed -i "s/${sgm_old_ver_sub}/${sgm_new_ver_sub}/g" src/markdown/sgm/re-sgm.md

      - name: Use Node.js 16.x
        uses: actions/setup-node@v2
        with:
          node-version: 16.x
          cache: 'npm'
      - run: npm install
      - run: npm run build

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v4
        with:
          commit-message: Update doc files.
          author: GitHub <noreply@github.com>
          signoff: false
          branch: deploy
          base: main
          labels: document
          delete-branch: false
          title: 'doc: update files and ready to deploy'
          body: |
            **åœ¨æå‡ºæ­¤æ‹‰å–è¯·æ±‚æ—¶ï¼Œæˆ‘ç¡®è®¤äº†ä»¥ä¸‹å‡ ç‚¹ï¼ˆä¿å­˜åè¯·ç‚¹å‡»å¤é€‰æ¡†ï¼‰ï¼š**
            
            - [x] æ ‡é¢˜ä¸ºfixã€featæˆ–docå¼€å¤´
            - [x] æˆ‘å·²æ£€æŸ¥æ²¡æœ‰ä¸æ­¤è¯·æ±‚é‡å¤çš„æ‹‰å–è¯·æ±‚ã€‚
            - [x] æˆ‘å·²ç»è€ƒè™‘è¿‡ï¼Œå¹¶ç¡®è®¤è¿™ä»½å‘ˆä»¶å¯¹å…¶ä»–äººå¾ˆæœ‰ä»·å€¼ã€‚
            - [x] æˆ‘æ¥å—æ­¤æäº¤å¯èƒ½ä¸ä¼šè¢«ä½¿ç”¨ï¼Œå¹¶æ ¹æ®ç»´æŠ¤äººå‘˜çš„æ„æ„¿å…³é—­æ‹‰å–è¯·æ±‚ã€‚
            
            **å¡«å†™PRå†…å®¹ï¼š**
            
            - Update files to deploy by bot ğŸš€.
            
          draft: false
          
      - name: Auto approve
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: juliangruber/approve-pull-request-action@v1
        with:
          github-token: ${{ secrets.PAT }}
          number: ${{ steps.cpr.outputs.pull-request-number }}
          
      - id: automerge
        if: steps.cpr.outputs.pull-request-operation == 'created'
        name: automerge
        uses: "pascalgn/automerge-action@v0.15.3"
        env:
          MERGE_LABELS: "document"
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          PULL_REQUEST: ${{ steps.cpr.outputs.pull-request-number }}
          MERGE_RETRIES: 18
          MERGE_RETRY_SLEEP: 10000
          
      - name: upload files to OSS
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: fangbinwei/aliyun-oss-website-action@v1
        with:
          accessKeyId: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          accessKeySecret: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
          bucket: sonic-assets-hongkong
          endpoint: oss-cn-hongkong.aliyuncs.com
          folder: dist/
          incremental: false
          
      - name: sync gitee
        if: steps.cpr.outputs.pull-request-operation == 'created'
        run: |
         remote_repo="https://${{ secrets.GITEE_USERNAME }}:${{ secrets.GITEE_PASSWORD }}@gitee.com/sonic-cloud/sonic-cloud.git"
         git remote add gitee "${remote_repo}"
         git show-ref # useful for debugging
         git branch --verbose
         git push --all --force gitee
         git push --tags --force gitee

      - name: Build Gitee Pages
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: yanglbme/gitee-pages-action@main
        with:
          gitee-username: ${{ secrets.GITEE_USERNAME }}
          gitee-password: ${{ secrets.GITEE_PASSWORD }}
          gitee-repo: sonic-cloud/sonic-cloud
          branch: deploy
          directory: dist
          https: false
